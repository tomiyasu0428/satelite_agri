# 圃場データベースアプリ - 現在の問題点と解決策

## 現在の状況

### ✅ 動作している機能
- Google Maps の表示（APIキー直接設定済み）
- ポリゴン描画機能
- 面積計算（ヘクタール表示）
- 新しいUI（年度・品種フィールド追加済み）

### ❌ 動作していない機能
- 圃場データの保存
- 圃場一覧の表示
- MongoDB との通信

## 問題点の詳細

### 1. APIローダーの問題
**エラー**: `listFields is not defined`

**原因**: 
- `js/api.loader.js` が適切にAPI実装を読み込めていない
- `apiMode: 'tables'` に設定したが、対応するAPI関数が未定義

**現在のAPIローダー**:
```javascript
// js/api.loader.js
(function chooseApi() {
  const cfg = window.APP_CONFIG || {};
  const mode = cfg.apiMode || 'tables';
  const head = document.head;
  const script = document.createElement('script');
  if (mode === 'external') {
    script.src = 'js/api.external.js';
  } else {
    script.src = 'js/api.js';  // ← このファイルが内蔵テーブルAPI用
  }
  head.appendChild(script);
})();
```

### 2. MongoDB接続の問題
**エラー**: サーバーに接続できない

**状況**:
- サーバーはポート3000で起動メッセージ表示
- しかし `curl localhost:3000` で接続拒否
- プロセスは存在するがネットワーク接続不可

### 3. 内蔵テーブルAPIの問題
**問題**: 
- `js/api.js` は内蔵テーブルAPI向けだが、実際には外部fetch API使用
- 年度・品種フィールドに未対応

**現在のapi.js**:
```javascript
async function createField(data) {
  const res = await fetch('tables/fields', {  // ← 内蔵テーブルAPI
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  });
  if (!res.ok) throw new Error('作成に失敗しました');
  return await res.json();
}
```

## 解決策

### 即座に解決する方法

#### Option A: モックAPIの実装
```javascript
// js/api.js を以下に置き換え
let mockData = [];
let nextId = 1;

async function listFields(page = 1, limit = 100) {
  return mockData;
}

async function createField(data) {
  const newField = {
    ...data,
    id: nextId++,
    _id: `mock_${nextId}`,
    created_at: new Date().toISOString(),
    updated_at: new Date().toISOString()
  };
  mockData.push(newField);
  return newField;
}

async function updateField(id, data) {
  const index = mockData.findIndex(f => f.id == id || f._id == id);
  if (index >= 0) {
    mockData[index] = { ...mockData[index], ...data, updated_at: new Date().toISOString() };
    return mockData[index];
  }
  throw new Error('Field not found');
}

async function deleteField(id) {
  const index = mockData.findIndex(f => f.id == id || f._id == id);
  if (index >= 0) {
    mockData.splice(index, 1);
  }
}
```

#### Option B: LocalStorageベースAPI
```javascript
// ブラウザのLocalStorageを使用したデータ永続化
const STORAGE_KEY = 'fields_data';

function getStoredFields() {
  const data = localStorage.getItem(STORAGE_KEY);
  return data ? JSON.parse(data) : [];
}

function saveFields(fields) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(fields));
}
```

### 根本的解決

#### MongoDB接続問題の解決
1. **ポート確認**:
   ```bash
   lsof -i :3000
   netstat -an | grep 3000
   ```

2. **ファイアウォール確認**:
   ```bash
   sudo ufw status
   ```

3. **サーバー再起動**:
   ```bash
   pkill -f "node.*server.js"
   npm start
   ```

#### データ構造の統一
新しい作付け履歴構造に全API実装を統一:
```javascript
{
  "name": "第1圃場",
  "area_ha": 2.5,
  "geometry": {...},
  "crop_history": [
    {
      "year": 2024,
      "crop": "小麦",
      "variety": "ゆめちから",
      "planting_date": null,
      "harvest_date": null
    }
  ],
  "current_crop": "小麦",
  "current_year": 2024
}
```

## 推奨する次のステップ

### ステップ1: 即座の動作確認
1. モックAPIを実装して基本機能をテスト
2. 年度・品種入力の動作確認
3. 作付け履歴データ構造の検証

### ステップ2: MongoDB接続修復
1. サーバープロセスの完全停止と再起動
2. ネットワーク設定の確認
3. CORS設定の再確認

### ステップ3: 本格運用準備
1. 全API実装の統一
2. エラーハンドリングの強化
3. データ検証の追加

## ファイル一覧

### 修正が必要なファイル
- `js/api.js` - 内蔵テーブルAPI実装（モック化推奨）
- `server.js` - MongoDB接続とCORS（ネットワーク問題解決後）
- `js/config.js` - APIモード設定

### 正常動作しているファイル
- `index.html` - UI（年度・品種フィールド追加済み）
- `js/main.js` - メインロジック（新フィールド対応済み）
- `js/api.external.js` - MongoDB API実装（サーバー接続後使用可能）

## 現在の優先度

1. **高**: モックAPIで基本動作確認
2. **中**: MongoDB接続問題の解決
3. **低**: 本格的なエラーハンドリング実装