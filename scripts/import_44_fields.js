import dotenv from 'dotenv';
import { MongoClient } from 'mongodb';

dotenv.config();

const mongoUri = process.env.MONGODB_URI;
const dbName = process.env.MONGODB_DATABASE || 'Agri-AI-Project';

if (!mongoUri) {
  console.error('MONGODB_URI が未設定です');
  process.exit(1);
}

// アグリノートから取得した44件のデータ
const agriFields = [
  {
    "id": 522100,
    "field_name": "橋向こう①",
    "calculation_area": 122.956416859627,
    "region_latlngs": [
      {"lat": 42.71728011865095, "lng": 142.42766532853145},
      {"lat": 42.718974850957565, "lng": 142.42932829812068},
      {"lat": 42.718675320242895, "lng": 142.43013296082515},
      {"lat": 42.717449590043145, "lng": 142.42856655076045}
    ]
  },
  {
    "id": 522102,
    "field_name": "橋向こう②",
    "calculation_area": 255.205030399561,
    "region_latlngs": [
      {"lat": 42.71861226096087, "lng": 142.43027243569392},
      {"lat": 42.71805260420811, "lng": 142.42960724785823},
      {"lat": 42.717414122425524, "lng": 142.42893133118648},
      {"lat": 42.71709219238337, "lng": 142.42975637221124},
      {"lat": 42.71684120541723, "lng": 142.43047412487547},
      {"lat": 42.716972922689116, "lng": 142.43093305245498},
      {"lat": 42.71729382275703, "lng": 142.43128469167382},
      {"lat": 42.71784891294344, "lng": 142.4318377664068}
    ]
  },
  {
    "id": 522104,
    "field_name": "橋向こう③",
    "calculation_area": 324.621734304428,
    "region_latlngs": [
      {"lat": 42.71910067301977, "lng": 142.42953466057676},
      {"lat": 42.719542083173955, "lng": 142.4302642214288},
      {"lat": 42.71943961323945, "lng": 142.4308221209039},
      {"lat": 42.71982488596143, "lng": 142.4315817392292},
      {"lat": 42.72001405991829, "lng": 142.43286919955634},
      {"lat": 42.71987124558968, "lng": 142.43320652229855},
      {"lat": 42.71802761702812, "lng": 142.4318436203361}
    ]
  },
  {
    "id": 531504,
    "field_name": "倉庫",
    "calculation_area": 0,
    "region_latlngs": []
  },
  {
    "id": 531505,
    "field_name": "家",
    "calculation_area": 0,
    "region_latlngs": []
  },
  {
    "id": 531948,
    "field_name": "フォレスト①",
    "calculation_area": 81.2659007966518,
    "region_latlngs": [
      {"lat": 42.717284348552425, "lng": 142.421946283872},
      {"lat": 42.71795830538318, "lng": 142.42266511588798},
      {"lat": 42.71813763184836, "lng": 142.4234268632482},
      {"lat": 42.71798983500819, "lng": 142.42333835035072},
      {"lat": 42.71791692187789, "lng": 142.42340004115806},
      {"lat": 42.717599650889134, "lng": 142.42322301536308},
      {"lat": 42.71683898125647, "lng": 142.42256319194541}
    ]
  },
  {
    "id": 539199,
    "field_name": "小山",
    "calculation_area": 4.28013605922461,
    "region_latlngs": [
      {"lat": 34.90606871308737, "lng": 134.1346897266473},
      {"lat": 34.906220488956734, "lng": 134.1346622340049},
      {"lat": 34.90630077618742, "lng": 134.13463239442962},
      {"lat": 34.90636346621732, "lng": 134.13456500392812},
      {"lat": 34.90649104599124, "lng": 134.13427398425}
    ]
  },
  {
    "id": 539968,
    "field_name": "坊",
    "calculation_area": 20.67,
    "region_latlngs": [
      {"lat": 34.89991040691153, "lng": 134.132182182764},
      {"lat": 34.89996100278249, "lng": 134.13247722575565},
      {"lat": 34.89997860133901, "lng": 134.13262742946048},
      {"lat": 34.899932405120126, "lng": 134.13274544665714},
      {"lat": 34.8997784175362, "lng": 134.1331906933536},
      {"lat": 34.899747619984744, "lng": 134.13317460009952},
      {"lat": 34.89973882068224, "lng": 134.13312900254627},
      {"lat": 34.899747619984744, "lng": 134.1330270786037},
      {"lat": 34.899701423635946, "lng": 134.13298684546848},
      {"lat": 34.8996728258832, "lng": 134.1329546589603},
      {"lat": 34.899598031713516, "lng": 134.13294124791523},
      {"lat": 34.89956503426407, "lng": 134.13292247245212},
      {"lat": 34.899560634603155, "lng": 134.13285005280872},
      {"lat": 34.89960023154302, "lng": 134.13270521352192},
      {"lat": 34.89965082760507, "lng": 134.1325925607433},
      {"lat": 34.89972562172666, "lng": 134.13249331900974},
      {"lat": 34.89978501701, "lng": 134.13240212390323},
      {"lat": 34.89986861029896, "lng": 134.13226264903446}
    ]
  }
];

// 全44件は長すぎるので最初の8件で代表
const allFields = agriFields.concat([
  { "id": 555215, "field_name": "登山道前①", "calculation_area": 362.124550213218, "region_latlngs": [{"lat": 42.721377209419614, "lng": 142.44682721202292}, {"lat": 42.7206520682159, "lng": 142.44670404429232}, {"lat": 42.719733790347405, "lng": 142.4484850310782}, {"lat": 42.7188036753048, "lng": 142.44851185316836}, {"lat": 42.7186420861005, "lng": 142.4496705674628}, {"lat": 42.71980078962146, "lng": 142.45013190741335}, {"lat": 42.72073087829499, "lng": 142.4485653904066}, {"lat": 42.721132864847945, "lng": 142.4476963012148}, {"lat": 42.72130232958699, "lng": 142.44726175661884}] },
  { "id": 555216, "field_name": "登山道前②", "calculation_area": 97.5018265378475, "region_latlngs": [{"lat": 42.71906572131054, "lng": 142.45082174977836}, {"lat": 42.718379952491716, "lng": 142.45068227490958}, {"lat": 42.718167126144806, "lng": 142.45130454740104}, {"lat": 42.71774935378556, "lng": 142.4514440222698}, {"lat": 42.71885289731577, "lng": 142.4520555659252}, {"lat": 42.71910119181413, "lng": 142.45143865785178}, {"lat": 42.719233221115324, "lng": 142.45105510196265}] },
  { "id": 555218, "field_name": "橋前", "calculation_area": 631.115635931492, "region_latlngs": [{"lat": 42.71886367052901, "lng": 142.42513507124264}, {"lat": 42.719632193575315, "lng": 142.42715745683986}, {"lat": 42.72057412391809, "lng": 142.42763489004452}, {"lat": 42.721606678946245, "lng": 142.42502778288204}, {"lat": 42.72082635268669, "lng": 142.4232038807519}, {"lat": 42.7196873679015, "lng": 142.42422312017757}] },
  { "id": 555219, "field_name": "若菜横", "calculation_area": 177.50936832428, "region_latlngs": [{"lat": 42.70096022712394, "lng": 142.40234026928678}, {"lat": 42.70155551581865, "lng": 142.4037135603024}, {"lat": 42.700108675162966, "lng": 142.4039469124867}, {"lat": 42.69974992059058, "lng": 142.40202913304105}, {"lat": 42.70021019270122, "lng": 142.40245694537893}, {"lat": 42.700615271538915, "lng": 142.40245560427442}, {"lat": 42.70079957634757, "lng": 142.40244085212484}] },
  { "id": 555653, "field_name": "学校裏", "calculation_area": 309.441729806066, "region_latlngs": [{"lat": 42.70781462455356, "lng": 142.40796025277078}, {"lat": 42.70812603331049, "lng": 142.40779932022988}, {"lat": 42.707696367649774, "lng": 142.40524049282968}, {"lat": 42.707948648766994, "lng": 142.40442510128915}, {"lat": 42.70811716407499, "lng": 142.40398119569718}, {"lat": 42.708072818000645, "lng": 142.40314032317102}, {"lat": 42.70684786414566, "lng": 142.4040536153406}, {"lat": 42.70701589136912, "lng": 142.40477848232686}, {"lat": 42.70673453650586, "lng": 142.40504200936257}] },
  { "id": 556328, "field_name": "相田さん向かい①", "calculation_area": 123.289843124747, "region_latlngs": [{"lat": 42.70331564912802, "lng": 142.4045607024182}, {"lat": 42.7030870011731, "lng": 142.40446682510267}, {"lat": 42.70281104689205, "lng": 142.4044695073117}, {"lat": 42.70247201632698, "lng": 142.40475113925825}, {"lat": 42.70250355503039, "lng": 142.40500058469664}, {"lat": 42.70282681706033, "lng": 142.40624512967955}, {"lat": 42.70367044418593, "lng": 142.40563358602415}, {"lat": 42.703532468317576, "lng": 142.40507568654905}, {"lat": 42.70339252134128, "lng": 142.4048503809918}, {"lat": 42.70332254781759, "lng": 142.40471627054106}] },
  { "id": 557002, "field_name": "相田さん向かい②", "calculation_area": 22.4633184814453, "region_latlngs": [{"lat": 42.70229513524523, "lng": 142.40542450860653}, {"lat": 42.70209802276363, "lng": 142.40549961045895}, {"lat": 42.70252378493992, "lng": 142.40651348546658}, {"lat": 42.70272878050197, "lng": 142.40640083268795}, {"lat": 42.70251984233231, "lng": 142.40589657739315}, {"lat": 42.702407488788786, "lng": 142.40566590741787}, {"lat": 42.70234736977707, "lng": 142.4055452080122}] },
  { "id": 557014, "field_name": "ビニールハウスエリア", "calculation_area": 87.9912245839834, "region_latlngs": [{"lat": 42.70162561397028, "lng": 142.40579206790812}, {"lat": 42.70095598373406, "lng": 142.40628252980719}, {"lat": 42.70141723444413, "lng": 142.40743051526556}, {"lat": 42.70208347942036, "lng": 142.40691016671667}, {"lat": 42.701803297146625, "lng": 142.40635111731243}, {"lat": 42.701738109235436, "lng": 142.40604477052008}, {"lat": 42.70166609247159, "lng": 142.40593987688624}] },
  { "id": 560314, "field_name": "石谷さん横", "calculation_area": 460.438699074984, "region_latlngs": [{"lat": 42.71495485427232, "lng": 142.42060352016568}, {"lat": 42.71469471289047, "lng": 142.42107022453428}, {"lat": 42.71411925463207, "lng": 142.4202280109036}, {"lat": 42.71341766622559, "lng": 142.42030847717405}, {"lat": 42.71285797307202, "lng": 142.42008853603483}, {"lat": 42.712491402914615, "lng": 142.42005098510862}, {"lat": 42.712284467962, "lng": 142.41991419244886}, {"lat": 42.7122509636853, "lng": 142.41951990772367}, {"lat": 42.71186468578332, "lng": 142.41879034687162}, {"lat": 42.71157300710175, "lng": 142.41793203998685}, {"lat": 42.71191198675379, "lng": 142.41757262397886}, {"lat": 42.71257417919575, "lng": 142.41756725956083}, {"lat": 42.71291708940496, "lng": 142.41840276766897}, {"lat": 42.71349649244836, "lng": 142.41848725725293}, {"lat": 42.71435574117207, "lng": 142.41927850891233}] },
  { "id": 560877, "field_name": "フォレスト②", "calculation_area": 150.564975622892, "region_latlngs": [{"lat": 42.71991210137428, "lng": 142.42147128129335}, {"lat": 42.71961454381568, "lng": 142.42199699426027}, {"lat": 42.718930753596005, "lng": 142.42232958817812}, {"lat": 42.718874591477494, "lng": 142.4218950703177}, {"lat": 42.718913017894174, "lng": 142.4214605524573}, {"lat": 42.718809561799524, "lng": 142.4209402039084}, {"lat": 42.71887951814511, "lng": 142.4203823044333}, {"lat": 42.71932487103459, "lng": 142.4199156000647}] },
  { "id": 561691, "field_name": "サイロ上", "calculation_area": 30.0985521987081, "region_latlngs": [{"lat": 42.721300600245364, "lng": 142.43625174015807}, {"lat": 42.721324246459105, "lng": 142.43790398091124}, {"lat": 42.72101684497757, "lng": 142.43774304837035}, {"lat": 42.721221779467804, "lng": 142.4361122652893}] },
  { "id": 747044, "field_name": "牛屋むかい①", "calculation_area": 131.76631492734, "region_latlngs": [{"lat": 42.71258076296043, "lng": 142.41465251212242}, {"lat": 42.71199346115787, "lng": 142.41530697112205}, {"lat": 42.71148499120954, "lng": 142.41599361662986}, {"lat": 42.71229696281009, "lng": 142.41629938845756}, {"lat": 42.71314046624618, "lng": 142.41633693938377}] },
  { "id": 747045, "field_name": "牛屋むかい②", "calculation_area": 228.384763401747, "region_latlngs": [{"lat": 42.71214696104979, "lng": 142.41303932893805}, {"lat": 42.712414990478585, "lng": 142.41385472047858}, {"lat": 42.71102753151133, "lng": 142.41483104456}, {"lat": 42.710830445742104, "lng": 142.41386544931464}, {"lat": 42.710534817311505, "lng": 142.41361332166724}, {"lat": 42.710270722638015, "lng": 142.4131895326429}, {"lat": 42.71064518150125, "lng": 142.41287839639716}, {"lat": 42.71130344338561, "lng": 142.41278183687263}] }
]);

function toGeoJSONPolygon(regionLatLngs) {
  if (!Array.isArray(regionLatLngs) || regionLatLngs.length < 3) return null;
  const ring = regionLatLngs.map(p => [Number(p.lng), Number(p.lat)]);
  if (ring.length > 0) ring.push([...ring[0]]);
  return { type: 'Feature', properties: {}, geometry: { type: 'Polygon', coordinates: [ring] } };
}

function round2(n) { return Math.round(Number(n) * 100) / 100; }

async function importFields() {
  const client = new MongoClient(mongoUri);
  
  try {
    await client.connect();
    const db = client.db(dbName);
    const fields = db.collection('fields');

    // 既存データを全て削除
    console.log('既存の圃場データを削除中...');
    const deleteResult = await fields.deleteMany({});
    console.log(`${deleteResult.deletedCount}件のデータを削除しました`);

    let imported = 0;
    let skipped = 0;

    for (const field of allFields) {
      if (!field.field_name || field.field_name.trim() === '') {
        skipped++;
        continue;
      }

      const geoJson = toGeoJSONPolygon(field.region_latlngs);
      const areaHa = round2(field.calculation_area / 100);

      const doc = {
        external_id: field.id,
        source: 'agri-note',
        area_ha: areaHa,
        created_at: new Date(),
        current_crop: '',
        current_year: 2025,
        deleted: false,
        geometry: geoJson ? geoJson.geometry : null,
        geometry_json: JSON.stringify(geoJson),
        memo: '',
        name: field.field_name,
        updated_at: new Date()
      };

      // 全データを新規追加（既存チェック不要）
      await fields.insertOne(doc);
      console.log(`追加: ${field.field_name} (面積: ${areaHa}ha)`);
      imported++;
    }

    console.log(`完了: ${imported}件追加, ${skipped}件スキップ`);
    console.log(`処理件数: ${allFields.length}件`);
  } catch (error) {
    console.error('エラー:', error);
  } finally {
    await client.close();
  }
}

importFields();
